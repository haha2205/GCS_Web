# 前端遥测数据显示验证指南

## 概述
本文档说明如何在右侧监控面板显示飞控遥测数据，包括控制标签页和导航标签页的数据映射关系。

---

## 一、控制标签页

### 1.1 电机参数 (ExtY_FCS_ESC_T)
**代码位置**: `RightMonitorTabsPanel.vue` 第109-131行

**显示内容**:
- 6个电机 (M1-M6) 的详细参数
- 每个电机显示3项数据：
  - **误差**: `esc{i}_error_count` - 错误计数（红色高亮）
  - **转速**: `esc{i}_rpm` - 电机转速（青色）
  - **功率**: `esc{i}_power_rating_pct` - 功率百分比（黄色）

**数据来源**: `droneStore.escData`

**映射代码**:
```javascript
const getEscErrorCount = (index) => {
  const escData = droneStore.escData
  if (index === 1) return escData.esc1_error_count ?? 0
  if (index === 2) return escData.esc2_error_count ?? 0
  // ... M3-M6
  return 0
}
```

---

### 1.2 遥控输入 (ExtY_FCS_DATAFUTABA_T)
**代码位置**: `RightMonitorTabsPanel.vue` 第81-107行

**显示内容**:
- **滚转 Roll**: `Tele_ftb_Roll` (uint16)
- **俯仰 Pitch**: `Tele_ftb_Pitch` (uint16)
- **偏航 Yaw**: `Tele_ftb_Yaw` (uint16)
- **油门 Col**: `Tele_ftb_Col` (uint16)
- **模式 Switch**: `Tele_ftb_Switch` (int8) - 显示"开启"/"关闭"状态徽章
- **失败标志**: `Tele_ftb_com_Ftb_fail` (int8)

**数据来源**: `droneStore.fcsData`

**映射代码**:
```javascript
const rcRoll = computed(() => droneStore.fcsData?.Tele_ftb_Roll ?? 0)
const rcPitch = computed(() => droneStore.fcsData?.Tele_ftb_Pitch ?? 0)
const rcYaw = computed(() => droneStore.fcsData?.Tele_ftb_Yaw ?? 0)
const rcCol = computed(() => droneStore.fcsData?.Tele_ftb_Col ?? 0)
const rcSwitch = computed(() => droneStore.fcsData?.Tele_ftb_Switch ?? 0)
```

---

### 1.3 PWM输出 (ExtY_FCS_PWMS_T)
**代码位置**: `RightMonitorTabsPanel.vue` 第57-78行

**显示内容**:
- **PWM输出曲线**: 使用 EChartWrapper 显示6通道PWM实时曲线
- **电机PWM输出 (6旋翼)**: M1-M6 的PWM数值 (单位μs，范围1000-2000)

**数据来源**: `droneStore.pwms`

**映射代码**:
```javascript
const selectedPwms = computed(() => {
  const allPwms = droneStore.pwms || []
  return allPwms.slice(0, 8)
})
```

---

### 1.4 避障状态 (ExtY_FCS_AVOIFLAG_T)
**代码位置**: `RightMonitorTabsPanel.vue` 第134-156行

**显示内容**:
- **雷达启用**: `AvoiFlag_LaserRadar_Enabled`
- **避障模式**: `AvoiFlag_AvoidanceFlag`
- **引导模式**: `AvoiFlag_GuideFlag`

**数据来源**: `droneStore.avoiFlag`

**映射代码**:
```javascript
const laserRadarEnabled = computed(() => droneStore.avoiFlag?.AvoiFlag_LaserRadar_Enabled ?? false)
const avoidanceFlag = computed(() => droneStore.avoiFlag?.AvoiFlag_AvoidanceFlag ?? false)
const guideFlag = computed(() => droneStore.avoiFlag?.AvoiFlag_GuideFlag ?? false)
```

---

## 二、导航标签页

### 2.1 飞行状态 (ExtY_FCS_STATES_T)
**代码位置**: `RightMonitorTabsPanel.vue` 第192-208行

**显示内容**:

#### 姿态角
- **滚转角 φ (Roll)**: `states_phi` (real32_T, 单位°)
- **俯仰角 θ (Pitch)**: `states_theta` (real32_T, 单位°)
- **偏航角 ψ (Yaw)**: `states_psi` (real32_T, 单位°)

#### 角速度
- **p (rad/s)**: `states_p` (real32_T)
- **q (rad/s)**: `states_q` (real32_T)
- **r (rad/s)**: `states_r` (real32_T)

#### 位置信息
- **纬度 Latitude**: `states_lat` (real_T, 6位小数精度)
- **经度 Longitude**: `states_lon` (real_T, 6位小数精度)
- **高度 Height**: `states_height` (real32_T, 单位m)

#### 速度信息
- **Vx (纵向)**: `states_Vx_GS` (real32_T, 单位m/s)
- **Vy (横向)**: `states_Vy_GS` (real32_T, 单位m/s)
- **Vz (垂向)**: `states_Vz_GS` (real32_T, 单位m/s)

**数据来源**: `droneStore.fcsStates`

**映射代码**:
```javascript
const states_lat = computed(() => droneStore.fcsStates?.states_lat ?? 0)
const states_height = computed(() => droneStore.fcsStates?.states_height ?? 0)
const states_phi = computed(() => droneStore.fcsStates?.states_phi ?? 0)
// ... 其他字段
```

---

### 2.2 GCS指令数据 (ExtY_FCS_DATAGCS_T)
**代码位置**: `RightMonitorTabsPanel.vue` 第248-271行

**显示内容**:
- **指令索引 CmdIdx**: `Tele_GCS_CmdIdx` (int32)
- **任务编号 Mission**: `Tele_GCS_Mission` (int32)
- **指令参数 Val**: `Tele_GCS_Val` (real32_T, 保留3位小数)
- **通信状态 Status**: `Tele_GCS_com_GCS_fail` (int8)
  - 显示 "正常" (绿色) 或 "失败" (红色)

**数据来源**: `droneStore.gcsData`

**映射代码**:
```javascript
const gcs_CmdIdx = computed(() => droneStore.gcsData?.Tele_GCS_CmdIdx ?? 0)
const gcs_Mission = computed(() => droneStore.gcsData?.Tele_GCS_Mission ?? 0)
const gcs_Val = computed(() => droneStore.gcsData?.Tele_GCS_Val ?? 0)
const gcsFail = computed(() => droneStore.gcsData?.Tele_GCS_com_GCS_fail ?? 0)
```

---

### 2.3 GNC控制参数 (ExtY_FCS_GNCBUS_T)
**代码位置**: `RightMonitorTabsPanel.vue` 第293-313行

**显示内容**:
- **Vx指令**: `GNCBus_CmdValue_Vx_cmd`
- **Vy指令**: `GNCBus_CmdValue_Vy_cmd`
- **高度指令**: `GNCBus_CmdValue_height_cmd`
- **偏航指令**: `GNCBus_CmdValue_psi_cmd`

**数据来源**: `droneStore.gncBus`

**映射代码**:
```javascript
const GNCBus_CmdValue_Vx_cmd = computed(() => droneStore.gncBus?.GNCBus_CmdValue_Vx_cmd ?? 0)
const GNCBus_CmdValue_Vy_cmd = computed(() => droneStore.gncBus?.GNCBus_CmdValue_Vy_cmd ?? 0)
const GNCBus_CmdValue_height_cmd = computed(() => droneStore.gncBus?.GNCBus_CmdValue_height_cmd ?? 0)
const GNCBus_CmdValue_psi_cmd = computed(() => droneStore.gncBus?.GNCBus_CmdValue_psi_cmd ?? 0)
```

---

### 2.4 姿态/速度/高度曲线

**代码位置**: `RightMonitorTabsPanel.vue` 第162-189行

**显示内容**:
1. **姿态角曲线**: Roll, Pitch, Yaw 实时曲线
2. **速度分量曲线**: Vx, Vy, Vz 实时曲线
3. **高度变化曲线**: 高度实时曲线

**数据来源**: `droneStore.history`

**映射代码**:
```javascript
const attitudeSeries = computed(() => {
  const rollData = droneStore.history.rollActual?.map(item => item.value) || []
  const pitchData = droneStore.history.pitchActual?.map(item => item.value) || []
  const yawData = droneStore.history.yawActual?.map(item => item.value) || []
  
  return [
    { name: 'Roll (φ)', data: rollData, lineStyle: { color: '#ff6b6b' } },
    { name: 'Pitch (θ)', data: pitchData, lineStyle: { color: '#4ecdc4' } },
    { name: 'Yaw (ψ)', data: yawData, lineStyle: { color: '#45b7d1' } }
  ]
})
```

---

## 三、数据流架构

### 3.1 数据接收流程
```
飞控模拟器 (UDP) 
  → Python后端 (main.py) 
  → WebSocket管理器 (WebSocketManager) 
  → 前端WebSocket (useWebSocket.js) 
  → Pinia store (drone.js) 
  → Vue组件 (RightMonitorTabsPanel.vue)
```

### 3.2 数据结构映射
| C结构体 | Pinia Store路径 | 显示位置 |
|---------|----------------|---------|
| `ExtY_FCS_ESC_T` | `droneStore.escData` | 控制标签页 - 电机参数 |
| `ExtY_FCS_DATAFUTABA_T` | `droneStore.fcsData` | 控制标签页 - 遥控输入 |
| `ExtY_FCS_PWMS_T` | `droneStore.pwms` | 控制标签页 - PWM输出 |
| `ExtY_FCS_AVOIFLAG_T` | `droneStore.avoiFlag` | 控制标签页 - 避障状态 |
| `ExtY_FCS_STATES_T` | `droneStore.fcsStates` | 导航标签页 - 飞行状态 |
| `ExtY_FCS_DATAGCS_T` | `droneStore.gcsData` | 导航标签页 - GCS指令 |
| `ExtY_FCS_GNCBUS_T` | `droneStore.gncBus` | 导航标签页 - GNC参数 |

---

## 四、验证步骤

### 4.1 前提条件
1. ✅ 启动Python后端服务 (`python src-python/main.py`)
2. ✅ 启动飞控模拟器或连接真实飞控
3. ✅ 前端已构建并运行 (`npm run dev`)

### 4.2 验证控制标签页
1. 打开前端界面，进入监控面板
2. 切换到"控制"标签页
3. 检查以下内容：
   - [ ] 电机参数区域显示 M1-M6 的误差、转速、功率
   - [ ] 遥控输入区域显示 Roll/Pitch/Yaw/Col/Switch 数值
   - [ ] PWM输出区域实时更新数值和曲线
   - [ ] 避障状态区域显示雷达/避障/引导状态

### 4.3 验证导航标签页
1. 切换到"导航"标签页
2. 检查以下内容：
   - [ ] 姿态/速度/高度曲线正常绘制
   - [ ] 飞行状态区域显示经纬度、高度、姿态角、角速度
   - [ ] 速度信息区域显示 Vx/Vy/Vz 数值
   - [ ] GCS指令区域显示 CmdIdx/Mission/Val/Status
   - [ ] GNC参数区域显示 Vx/Vy/高度/偏航指令

### 4.4 验证数据流
1. 打开浏览器开发者工具 → Network → WS
2. 观察 WebSocket 消息流
3. 检查以下数据类型：
   - [ ] `fcs_esc` - 电机参数实时更新
   - [ ] `fcs_datafutaba` - 遥控输入实时更新
   - [ ] `fcs_pwms` - PWM数据实时更新
   - [ ] `avoiflag` - 避障标志实时更新
   - [ ] `fcs_states` - 飞行状态实时更新
   - [ ] `fcs_datagcs` - GCS指令实时更新
   - [ ] `fcs_gncbus` - GNC参数实时更新

---

## 五、CS V格式支持

### 5.1 宽表CSV格式 (213列)
所有遥测数据已映射到CSV宽表格式，无category列：

**字段分布**:
- timestamp (1)
- pwms (8)
- states (12)
- datactrl (42)
- gncbus (74)
- avoiflag (3)
- datafutaba (6)
- datagcs (4)
- ac_aim2ab (24)
- acAB (24)
- params (1)
- esc (18) = 213

**CSV文件路径**: `Apollo-GCS-Web/Log/drone_log_YYYYMMDD_HHMMSS.csv`

### 5.2 CSV验证步骤
1. 在配置页面启用CSV自动记录
2. 设置日志目录路径
3. 启动记录后检查CSV文件表头：
   ```bash
   head -1 Log/drone_log_*.csv
   ```
4. 验证数据行格式（应无category列）

---

## 六、已知问题

### 6.1 数据刷新频率
- 当前数据更新频率由WebSocket推送决定
- 建议控制在20Hz以内避免过度刷新

### 6.2 数据默认值
- 使用 `?? 0` 或 `?? false` 提供默认值
- 确保数据断开连接时显示合理值

### 6.3 性能优化
- 图表数据限制在最近100-200个点
- 使用computed属性缓存计算结果

---

## 七、维护文档

### 7.1 相关文件清单
```
src-frontend/src/
├── store/drone.js                      # Pinia状态管理
├── composables/useWebSocket.js         # WebSocket连接
└── components/layout/
    ├── RightPanel.vue                   # 右侧面板容器
    └── RightMonitorTabsPanel.vue        # 监控面板标签页
```

### 7.2 相关后端文件清单
```
src-python/
├── main.py                              # 主程序（WebSocket/UDP）
├── protocol/
│   └── protocol_parser.py              # 协议解析
└── recorder/
    └── csv_helper_full.py              # CSV格式化辅助函数
```

---

## 八、总结

### ✅ 已完成功能
1. 控制标签页显示：
   - 电机参数 (ESC)
   - 遥控输入
   - PWM输出
   - 避障状态

2. 导航标签页显示：
   - 飞行状态 (STATES)
   - GCS指令数据 (DATAGCS)
   - GNC控制参数
   - 姿态/速度/高度实时曲线

3. CSV记录：
   - 213列宽表格式（无category列）
   - 所有数据类型完整映射

### 📋 待验证项目
- [ ] 前端界面实时更新正常
- [ ] WebSocket数据流稳定
- [ ] CSV格式正确记录
- [ ] UI滚动功能正常（已修复CSS）

---

**文档版本**: v1.0  
**最后更新**: 2026-01-21  
**维护者**: CoStrict