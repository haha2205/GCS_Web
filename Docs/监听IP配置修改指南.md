# 监听IP配置修改功能说明

## 📋 功能概述

现在支持修改地面站的**监听地址**，而不仅仅是目标IP。

### 配置项说明

| 配置项 | 说明 | 默认值 | 用途 |
|-------|------|--------|------|
| **监听地址** | 地面站UDP服务器绑定的本地IP | `0.0.0.0` | 接收飞控/LiDAR/规划数据的地址 |
| 监听端口 | 地面站UDP服务器绑定的端口 | `30509, 18507, 18511` | 接收数据的端口 |
| 目标IP | 飞控设备的IP地址 | `127.0.0.1` | 发送控制指令的目标地址 |
| 目标端口 | 飞控接收指令的端口 | `18504` | 发送控制指令的目标端口 |

### 监听地址说明

| 取值 | 含义 | 适用场景 | 注意事项 |
|------|------|---------|---------|
| `0.0.0.0` | 监听所有网络接口 | 多设备接入、开发测试 | ⭐ 最灵活，推荐默认值 |
| `127.0.0.1` | 仅监听本地回环接口 | 本地测试、模拟器调试 | 只能接收本机数据 |
| `192.168.x.x` | 监听指定IP的网卡 | 生产环境、安全要求高 | 需确认地面站的IP地址 |

### 配置修改指南

#### ⚠️ 监听配置修改（需要重启UDP）

当修改以下任意一项时，**必须重启UDP服务器**（会断开约1秒）：
- 监听地址
- hostPort (30509)
- lidarSendPort (18507)
- planningRecvPort (18511)

**影响**：
- ✅ 新的配置立即生效
- ✅ 支持动态切换网络接口
- ⚠️ 短暂断开连接（约1秒）

#### ✅ 目标配置修改（不需要重启UDP）

当修改以下任意一项时，**无需重启UDP服务器**：
- 目标IP
- commandRecvPort (18504)
- planningSendPort (18510)

**影响**：
- ✅ 不影响数据接收
- ✅ 实时更新发送目标
- ✅ 无需停机切换设备

#### ⚠️ 暂不建议修改

以下端口是预留端口，暂不建议修改：
- sendOnlyPort (18506)
- planningSendPort (生产环境中已由 planningRecvPort (18511) 替代)

## 🎯 使用场景

### 场景1：默认配置（多网卡环境）
```
监听地址: 0.0.0.0
监听端口: [30509, 18507, 18511]
目标IP: 192.168.1.100
目标端口: 18504
```
✅ 地面站可以从任何IP接收数据

### 场景2：指定网卡（单网卡环境）
```
监听地址: 192.168.1.10
监听端口: [30509, 18507, 18511]
目标IP: 192.168.1.100
目标端口: 18504
```
✅ 地面站只监听指定IP，更安全

### 场景3：本地测试（回环）
```
监听地址: 127.0.0.1
监听端口: [30509, 18507, 18511]
目标IP: 127.0.0.2
目标端口: 18504
```
✅ 用于本地测试，不占用真实网卡

## 🔧 代码实现

### 后端修改 (main.py)

#### 1. ConnectionConfig 数据模型
```python
class ConnectionConfig(BaseModel):
    """UDP连接配置"""
    protocol: str = "udp"
    listenAddress: str = "0.0.0.0"  # ⭐ 新增：监听地址
    hostPort: int = 30509
    remoteIp: str = "127.0.0.1"
    commandRecvPort: int = 18504
    sendOnlyPort: int = 18506
    lidarSendPort: int = 18507
    planningSendPort: int = 18510
    planningRecvPort: int = 18511
```

#### 2. 配置变化检测逻辑
```python
# 检测配置变化类型
# 1. 监听配置是否改变（监听地址或端口改变，需要重启UDP服务器）
listen_config_changed = (
    connection_config.listenAddress != config.listenAddress or  # ⭐ 新增监听地址检测
    connection_config.hostPort != config.hostPort or
    connection_config.lidarSendPort != config.lidarSendPort or
    connection_config.planningRecvPort != config.planningRecvPort
)

# 2. 发送目标（IP+端口）是否改变（只需更新目标地址，不需要重启）
target_changed = (
    connection_config.remoteIp != config.remoteIp or
    connection_config.commandRecvPort != config.commandRecvPort
)
```

#### 3. 启动服务器时使用监听地址
```python
# 场景1：仅监听配置改变 - 需要重启UDP服务器
if listen_config_changed and not target_changed:
    # ... 停止旧服务器 ...
    
    # 使用配置中的监听地址 ⭐
    await udp_handler.start_server(host=config.listenAddress, ports=ports)
    logger.info(f"✓ UDP服务器已重启")
    logger.info(f"  监听地址: {config.listenAddress}")
    logger.info(f"  监听端口: {ports}")
```

### 前端修改 (LeftConfigPanel.vue)

#### 1. 配置界面
```vue
<div class="config-subsection">
  <div class="subsection-title">本地端（GCS）</div>
  <div class="config-row">
    <label>监听地址</label>  <!-- ⭐ 改为"监听地址" -->
    <input v-model="listenAddress" type="text" 
           class="config-input" placeholder="0.0.0.0" />
  </div>
  <div class="config-row">
    <label>监听端口</label>
    <input v-model.number="hostPort" type="number" 
           class="config-input" placeholder="30509" />
  </div>
</div>
```

#### 2. 数据保存
```javascript
const config = {
  protocol: protocol.value,
  listenAddress: listenAddress.value,  // ⭐ 新增监听地址
  hostPort: hostPort.value,
  remoteIp: remoteIp.value,
  // ...
}
await connectionApi.updateConfig(config)
```

## 📊 场景判断逻辑

### 场景1：仅监听配置改变
**条件**：`listen_config_changed = true` 且 `target_changed = false`  
**操作**：重启UDP服务器  
**示例**：修改 `0.0.0.0` → `192.168.1.10`

### 场景2：仅目标地址改变
**条件**：`listen_config_changed = false` 且 `target_changed = true`  
**操作**：更新UDP发送目标，不重启服务器  
**示例**：修改 `192.168.1.100` → `192.168.1.101`

### 场景3：无任何改变
**条件**：`listen_config_changed = false` 且 `target_changed = false`  
**操作**：仅保存配置  
**示例**：点击保存但未修改任何值

### 场景4：监听配置和目标都改变
**条件**：`listen_config_changed = true` 且 `target_changed = true`  
**操作**：停止服务器 → 等待1秒 → 重启服务器并更新目标  
**示例**：同时修改监听地址和目标IP

## 🧪 测试步骤

### 测试1：修改监听地址（多网卡场景）

**前置条件**：
- 后端已启动
- UDP服务器正在运行

**测试步骤**：
1. 打开前端配置面板
2. 修改"监听地址"从 `0.0.0.0` 改为 `192.168.1.10`
3. 点击"保存连接配置"

**预期结果**：
```
✓ 后端日志：
  场景1: 监听配置已改变，重启UDP服务器
  监听地址: 192.168.1.10
  UDP服务器已停止
  ✓ UDP服务器已重启
    监听地址: 192.168.1.10
    监听端口: [30509, 18507, 18511]
```

### 测试2：仅修改目标IP

**前置条件**：
- 后端已启动
- UDP服务器正在运行

**测试步骤**：
1. 打开前端配置面板
2. 修改"远程端（飞控）→ Remote IP"从 `127.0.0.1` 改为 `192.168.1.100`
3. 点击"保存连接配置"

**预期结果**：
```
✓ 后端日志：
  场景2: 仅目标地址改变，更新发送目标
  发送目标: 192.168.1.100:18504
  ✓ UDP发送目标已更新: 192.168.1.100:18504
```

### 测试3：同时修改监听地址和目标IP

**前置条件**：
- 后端已启动
- UDP服务器正在运行

**测试步骤**：
1. 打开前端配置面板
2. 修改"监听地址"从 `0.0.0.0` 改为 `192.168.1.10`
3. 修改"远程端（飞控）→ Remote IP"从 `127.0.0.1` 改为 `192.168.1.100`
4. 点击"保存连接配置"

**预期结果**：
```
✓ 后端日志：
  场景4: 监听配置和目标地址都改变
  UDP服务器已停止
  ✓ UDP服务器已重启
    监听地址: 192.168.1.10
    监听端口: [30509, 18507, 18511]
    发送目标: 192.168.1.100:18504
```

### 测试4：验证绑定不同网卡

**步骤**：
1. 使用 `netstat -ano | findstr LISTENING` 查看UDP端口绑定
2. 修改监听地址为 `127.0.0.1`
3. 保存配置
4. 再次查看端口绑定状态

**预期结果**：
```
修改前:
  UDP    0.0.0.0:30509    *:*    (所有网卡)

修改后:
  UDP    127.0.0.1:30509  *:*    (仅回环接口)
```

## 🔍 验证清单

- [ ] 前端显示"监听地址"配置项（而非"Host IP"）
- [ ] 默认值为 `0.0.0.0`
- [ ] 修改监听地址时，UDP服务器正确重启
- [ ] 仅修改目标IP时，UDP服务器不重启
- [ ] 同时修改监听地址和目标IP时，正确重启并更新目标
- [ ] 后端日志明确显示监听地址
- [ ] 网络绑定正确使用新的监听地址
- [ ] 配置保存后，前端立即获取最新配置

## ❓ 常见问题

### Q1: 为什么默认监听地址是 `0.0.0.0`？

**A**: `0.0.0.0` 表示监听所有可用的网络接口，这是最灵活的配置。在有多个网卡的服务器上，这样可以从任何网卡接收数据。

### Q2: 什么时候需要修改监听地址？

**A**:
- 需要限制地面站只从特定网卡接收数据时（安全考虑）
- 服务器有多个IP，需要指定特定IP时
- 本地测试时，使用 `127.0.0.1` 避免干扰真实网络

### Q3: 修改监听地址会断开连接吗？

**A**: 会。修改监听地址需要重启UDP服务器，会短暂断开约1秒（等待端口释放）。

### Q4: 监听地址和目标IP的区别？

**A**:
- **监听地址**：地面站自己绑定在哪个IP上接收数据
- **目标IP**：地面站把控制指令发送到哪个IP

类比：
- 监听地址 = 你的手机号码（别人能拨打）
- 目标IP = 你要拨打的号码

### Q5: 遇到 `[WinError 10049] 在其上下文中，该请求的地址无效` 怎么办？

**A**: 这个错误表示**尝试绑定的IP地址不是本机的有效IP地址**。

**解决方法**：
1. **方案1（推荐）**：使用 `0.0.0.0` 而非具体IP
   - 监听所有接口，避免IP地址问题
   - 支持多设备同时接入

2. **方案2**：检查本机IP地址
   - Windows: `ipconfig` 或 `ipconfig /all`
   - Linux/Mac: `ifconfig` 或 `ip addr show`
   - 确认要绑定的IP确实存在

3. **方案3**：使用回环地址（本地测试）
   - `127.0.0.1` 用于本地测试
   - 配合目标IP `127.0.0.1` 使用

**检查本机IP的命令**：
```bash
# Windows
ipconfig

# 查找 "IPv4 地址" 字段
# 例如：IPv4 地址 . . . . : 192.168.1.5

# Linux/Mac
ip addr show

# 查找 "inet" 地址
# 例如：inet 192.168.1.5/24 brd 192.168.1.255
```

### Q6: 如何验证监听地址配置是否正确？

**A**: 使用以下方法验证：

**方法1：检查UDP端口绑定状态**
```bash
# Windows
netstat -ano | findstr LISTENING | findstr ":30509\|:18507\|:18511"

# Linux/Mac
netstat -tuln | grep ":30509\|:18507\|:18511"
```

**预期输出示例**：
```
# 监听 0.0.0.0:30509
UDP    0.0.0.0:30509    *:*    (所有接口)

# 监听 192.168.1.5:30509
UDP    192.168.1.5:30509  *:*    (仅指定IP)
```

**方法2：查看后端日志**
```
✓ UDP监听器已启动: 0.0.0.0:30509 (类型: PORT_18506_TELEMETRY)
✓ UDP监听器已启动: 0.0.0.0:18507 (类型: PORT_18507_LIDAR)
✓ UDP监听器已启动: 0.0.0.0:18511 (类型: PORT_18511_PLANNING)
```

**方法3：前端状态显示**
- 右上角状态栏应显示 "已连接"
- 配置面板应显示正确的监听地址和端口

## 📝 网络绑定示例

### 示例1：多网卡服务器

```
服务器IP配置:
  eth0: 192.168.1.10 (连接飞控)
  eth1: 192.168.2.10 (连接局域网)

配置选项:
方案1: listenAddress = "0.0.0.0" ⭐（推荐用于多设备场景）
✅ 可接收来自任何网卡的数据
✅ 支持飞控、相机、LiDAR等多设备接入
✅ 设备IP变化不影响数据接收
⚠️ 安全性较低（需要防火墙补充）

方案2: listenAddress = "192.168.1.10"
✅ 只接收来自飞控网卡的数据
✅ 安全性高
❌ 多设备接入需要复杂配置
```

### 示例3：多设备接入（相机+飞控）
```
场景：地面站需要同时接收飞控和相机数据

网络拓扑:
地面站服务器:   192.168.1.5
飞控设备:      192.168.1.10 (发送UDP到 192.168.1.5:30509)
相机设备:      192.168.1.20 (发送UDP到 192.168.1.5:8888)
LiDAR设备:     192.168.1.30 (发送UDP到 192.168.1.5:18507)

推荐配置:
listenAddress: "0.0.0.0"      # ✅ 关键：监听所有网卡
listenPorts: [30509, 18507, 18511, 8888]

工作原理:
1. 地面站绑定到所有网卡 (0.0.0.0:30509, :18507, :18511, :8888)
2. 飞控发送到 192.168.1.5:30509 → 地面站收到 ✅
3. 相机发送到 192.168.1.5:8888   → 地面站收到 ✅
4. LiDAR发送到 192.168.1.5:18507 → 地面站收到 ✅

如果使用具体IP (192.168.1.5):
❌ 相机/飞控需要知道地面站IP
❌ 添加新设备需要修改地面站配置
❌ 网络结构调整时需要重新配置
```

### 示例2：开发测试

```
开发环境:
  本机运行飞控模拟器: 127.0.0.1:18504
  本机运行地面站: 127.0.0.1:30509

推荐配置:
  listenAddress: "127.0.0.1"
  remoteIp: "127.0.0.1"
```

## 🚀 性能优化建议

### 不同环境推荐配置

| 环境类型 | 监听地址 | 目标IP配置 | 端口配置 | 说明 |
|---------|----------|-----------|---------|------|
| **生产环境** | `192.168.1.10`（具体IP）| `192.168.1.100` | 默认端口 | 提高安全性，减少不必要的网络监听 |
| **开发环境** | `127.0.0.1`| `127.0.0.1` | 默认端口 | 避免干扰真实网络，测试隔离 |
| **多设备环境** | `0.0.0.0` | 多个设备IP | 默认端口 | 支持飞控、相机、LiDAR等多设备同时接入 |
| **调试环境** | `0.0.0.0` | 灵活配置 | 可变端口 | 灵活性最高，便于多端测试 |

### 配置修改决策树

```
需要修改配置？
    ├─ 只改发送目标（目标IP/目标端口）？
    │   └─ ✅ 修改即可，无需重启
    │
    ├─ 改监听配置（监听地址/监听端口）？
    │   └─ ⚠️  需要重启UDP（会断开约1秒）
    │
    └─ 同时改监听和目标？
        └─ ⚠️  需要重启UDP并更新目标

## 📚 相关文档

- [快速启动检查清单](./快速启动检查清单.md)
- [IP配置说明](./IP配置说明.md)
- [UDP连接修复总结](./UDP连接修复总结.md)

---

**文档版本**: v1.0  
**最后更新**: 2026-01-22  
**维护者**: CoStrict