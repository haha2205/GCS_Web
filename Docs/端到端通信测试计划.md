# Apollo-GCS Web 端到端通信测试计划

## 测试目标

验证前端-后端-飞控模拟端的完整通信链路，测试从前端发送指令到飞控模拟端接收的端到端功能。

## 测试范围

### 1. 飞控指令接收端测试（fc_command_recv.py）

**测试模块：** 飞控指令接收端（端口18504）

**功能验证：**
- ✓ 接收来自地面站的ExtU_FCS_T控制参数（命令字0x40）
- ✓ 解析PID控制参数
- ✓ 解析任务指令
- ✓ 发送ACK响应确认
- ✓ 协议帧验证（帧头、帧尾、校验和）

### 2. 前端指令发送测试

**测试模块：** LeftCommandPanel（左侧指令面板）和 LeftParamsPanel（左侧参数面板）

**测试用例：**
1. **PID参数发送测试**
   - 滚转PID参数发送
   - 俯仰PID参数发送
   - 偏航PID参数发送
   - 高度PID参数发送

2. **任务指令发送测试**
   - 起飞指令
   - 降落指令
   - 返航指令
   - 悬停指令

3. **控制参数发送测试**
   - 模式切换
   - 应急控制

### 3. 后端UDP通信测试

**测试模块：** Python后端（main.py）

**功能验证：**
- ✓ WebSocket接收前端指令
- ✓ 协议封装（0x40命令字，协议帧格式）
- ✓ UDP发送到飞控模拟端（127.0.0.1:18504）
- ✓ 错误处理和日志记录

### 4. 端到端集成测试

**测试场景1：PID参数链路测试**
```
前端用户操作 → WebSocket → 后端处理 → UDP协议封装 → 飞控模拟端接收 → 解析验证
```

**测试场景2：任务指令链路测试**
```
前端点击起飞 → WebSocket → 后端处理 → UDP协议封装 → 飞控模拟端接收 → 确认响应
```

## 测试环境

### 系统配置
- **操作系统：** Windows 11
- **Python版本：** 3.7+
- **Node.js版本：** 16+
- **前端端口：** 5173（Vite开发服务器）
- **后端端口：** 8000（Python后端）

### 网络配置
```
前端 (localhost:5173)
    ↓ WebSocket
后端 (localhost:8000)
    ↓ UDP 127.0.0.1:18504
飞控模拟端 (fc_command_recv.py)
```

### 端口分配
| 端口 | 用途 | 方向 |
|------|------|------|
| 5173 | 前端开发服务器 | HTTP |
| 8000 | 后端API服务器 | HTTP/WebSocket |
| 18504 | 飞控指令接收 | UDP（地面站→飞控） |

## 测试步骤

### 阶段1：环境准备

1. **检查依赖安装**
   ```bash
   cd Apollo-GCS-Web/src-python
   pip install -r requirements.txt
   ```

2. **启动飞控模拟器**
   ```bash
   cd udp_communication_test
   python fc_command_recv.py
   ```

3. **启动后端服务器**
   ```bash
   cd Apollo-GCS-Web/src-python
   python main.py
   ```

4. **启动前端开发服务器**
   ```bash
   cd Apollo-GCS-Web/src-frontend
   npm run dev
   ```

### 阶段2：功能测试

#### 测试1：PID参数发送

**步骤：**
1. 打开浏览器访问 http://localhost:5173
2. 导航到"参数配置"面板
3. 修改PID参数（例如：P=1.5, I=0.1, D=0.5）
4. 点击"发送PID参数"按钮
5. 观察飞控模拟端控制台输出

**预期结果：**
- 前端显示发送成功
- 后端记录指令接收日志
- 飞控模拟端显示接收到的PID参数
- 协议帧格式正确（0xFF 0xFC 0x40 ... 0xA1 0xA2）

#### 测试2：任务指令发送

**步骤：**
1. 导航到"指令控制"面板
2. 点击"起飞"按钮
3. 点击"降落"按钮
4. 点击"返航"按钮
5. 观察飞控模拟端控制台输出

**预期结果：**
- 前端按钮状态正确更新
- 后端接收任务指令
- 飞控模拟端解析任务类型
- 发送ACK响应确认

#### 测试3：多指令并发发送

**步骤：**
1. 快速连续发送多个PID参数修改
2. 同时发送任务指令和PID参数
3. 观察系统处理能力

**预期结果：**
- 所有指令均被正确接收
- 无数据丢失或乱序
- 飞控模拟端正确解析每个数据包

### 阶段3：异常测试

#### 测试4：网络中断恢复

**步骤：**
1. 正常发送指令
2. 暂停飞控模拟器
3. 前端继续发送指令
4. 重启飞控模拟器
5. 重新发送指令

**预期结果：**
- 网络中断时后端记录错误
- 飞控模拟器重启后正常接收数据
- 后端自动重连机制正常

#### 测试5：协议错误处理

**步骤：**
1. 修改协议测试数据（错误的帧头/帧尾）
2. 发送到飞控模拟端
3. 观察错误处理

**预期结果：**
- 飞控模拟端检测到协议错误
- 返回错误响应或记录错误日志
- 后端处理异常情况

## 测试数据

### PID参数测试数据
```
滚转PID: P=1.5, I=0.1, D=0.5
俯仰PID: P=1.8, I=0.12, D=0.6
偏航PID: P=2.0, I=0.15, D=0.7
高度PID: P=1.2, I=0.08, D=0.4
```

### 任务指令测试数据
```
起飞指令: Mission=1, Val=10.0
降落指令: Mission=2, Val=0.0
返航指令: Mission=3, Val=0.0
悬停指令: Mission=4, Val=5.0
```

## 验收标准

### 功能验收
- [ ] 所有测试用例执行通过
- [ ] 前端、后端、飞控模拟端无报错
- [ ] 飞控模拟端正确接收100%的指令
- [ ] 协议帧格式符合MiniQGCLinkV2.0规范

### 性能验收
- [ ] 指令发送延迟 < 100ms
- [ ] 支持10次/秒的指令发送频率
- [ ] 内存使用稳定，无内存泄漏

### 稳定性验收
- [ ] 连续运行1小时无异常
- [ ] 处理1000条以上指令无错误
- [ ] 异常情况自动恢复

## 测试报告模板

### 测试环境
- 测试日期：
- 测试人员：
- 系统版本：

### 测试结果
| 测试用例 | 测试状态 | 备注 |
|---------|---------|------|
| PID参数发送 | 通过/失败 | |
| 任务指令发送 | 通过/失败 | |
| 多指令并发 | 通过/失败 | |
| 网络中断恢复 | 通过/失败 | |
| 协议错误处理 | 通过/失败 | |

### 问题记录
| 问题编号 | 问题描述 | 严重程度 | 状态 |
|---------|---------|---------|------|

### 测试结论
- 总体评价：
- 建议改进：
- 通过/不通过：

## 附录

### 协议帧格式参考
```
[帧头2字节] [命令1字节] [长度2字节] [数据N字节] [校验1字节] [帧尾2字节]
   FF FC       0x40         LL HH        data         CS         A1 A2
```

### 日志位置
- **飞控模拟端日志：** udp_communication_test/fc_command_recv.py控制台
- **后端日志：** Apollo-GCS-Web/src-python/main.py控制台
- **前端日志：** 浏览器开发者工具Console

---
**文档版本：** v1.0
**创建日期：** 2026-01-20
**最后更新：** 2026-01-20