# Apollo-GCS åç«¯æ•°æ®å¤„ç†èƒ½åŠ›è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜Apollo-GCS Webåç«¯å·²å…·å¤‡çš„æ•°æ®å¤„ç†èƒ½åŠ›ã€æ”¯æŒçš„åè®®æ•°æ®ç±»å‹ã€APIæ¥å£ä»¥åŠä»£ç ç»“æ„ã€‚

---

## ğŸ¯ æ ¸å¿ƒèƒ½åŠ›

### 1. UDPæ•°æ®æ¥æ”¶ä¸è§£æ

åç«¯é€šè¿‡å¤šç«¯å£UDPæœåŠ¡å™¨æ¥æ”¶é£æ§/é›·è¾¾å‘é€çš„NCLinkV2.0åè®®æ•°æ®åŒ…ã€‚

#### æ”¯æŒçš„æ•°æ®ç±»å‹

| åŠŸèƒ½ç  | æ•°æ®ç±»å‹ | Pythonç»“æ„ä½“ | è½½è·å¤§å° | è¯´æ˜ |
|--------|---------|------------|---------|------|
| 0x42 | `fcs_states` | `ExtY_FCS_STATES_T` | 56å­—èŠ‚ | é£è¡ŒçŠ¶æ€ï¼šä½ç½®ã€é€Ÿåº¦ã€å§¿æ€ã€è§’é€Ÿåº¦ |
| 0x41 | `fcs_pwms` | `ExtY_FCS_PWMS_T` | 64å­—èŠ‚ | 8ä¸ªç”µæœºPWMè¾“å‡ºå€¼ |
| 0x43 | `fcs_datactrl` | `ExtY_FCS_DATACTRL_T` | 32å­—èŠ‚ | æ§åˆ¶å¾ªç¯ï¼šå‚è€ƒå€¼ã€è§‚æµ‹å€¼ã€æ§åˆ¶è¾“å‡º |
| 0x44 | `fcs_gncbus` | `ExtY_FCS_GNCBUS_T` | 36+å­—èŠ‚ | GN&Cæ€»çº¿ï¼šä½ç½®ã€å§¿æ€ã€æ§åˆ¶æ¨¡å¼ |
| 0x45 | `avoiflag` | `ExtY_FCS_AVOIFLAG_T` | 3å­—èŠ‚ | é¿éšœæ ‡å¿—ï¼šé›·è¾¾çŠ¶æ€ã€é¿éšœæ¿€æ´» |
| 0x49 | `fcs_param` | `ExtY_FCS_PARAM_T` | 4å­—èŠ‚ | é£æ§å‚æ•°ï¼šæ—¶é—´æˆ³ |
| 0x4B | `fcs_esc` | `ExtY_FCS_ESC_T` | 60å­—èŠ‚ | ç”µæœºESCï¼šé”™è¯¯è®¡æ•°ã€è½¬é€Ÿã€åŠŸç‡ |

#### æ•°æ®å­—æ®µè¯¦è§£

### ğŸ“ é£è¡ŒçŠ¶æ€æ•°æ® (fcs_states)

```json
{
  "latitude": 39.0842,           // çº¬åº¦ (double)
  "longitude": 117.201,          // ç»åº¦ (double)
  "altitude": 25.5,              // æµ·æ‹”é«˜åº¦ (float)
  "velocity_x": 2.5,             // ä¸œå‘é€Ÿåº¦ (float)
  "velocity_y": 1.2,             // åŒ—å‘é€Ÿåº¦ (float)
  "velocity_z": 0.5,             // å‚å‘é€Ÿåº¦ (float)
  "angular_velocity_x": 0.02,    // æ»šè½¬è§’é€Ÿåº¦ (float)
  "angular_velocity_y": 0.03,    // ä¿¯ä»°è§’é€Ÿåº¦ (float)
  "angular_velocity_z": 0.01,    // åèˆªè§’é€Ÿåº¦ (float)
  "roll": 5.2,                   // æ¨ªæ»šè§’ (float, åº¦)
  "pitch": 2.1,                  // ä¿¯ä»°è§’ (float, åº¦)
  "yaw": 180.5                  // åèˆªè§’ (float, åº¦)
}
```

### ğŸ”Œ æ§åˆ¶å¾ªç¯æ•°æ® (fcs_datactrl)

```json
{
  "ailOutLoop": {
    "dY_delta": 0.001,       // åå·® delta
    "Vy_dY2Vy": 0.5,        // é€Ÿåº¦è½¬æ¢ç³»æ•°
    "Vy_P": 1.2,            // æ¯”ä¾‹å¢ç›Š
    "Vy_Int": 0.8,           // ç§¯åˆ†å¢ç›Š
    "Vy_D": 0.3,            // å¾®åˆ†å¢ç›Š
    "ail_ffc": 0.95         // å‰é¦ˆè¡¥å¿
  }
}
```

### ğŸ¯ GN&Cæ€»çº¿æ•°æ® (fcs_gncbus)

```json
{
  "pos_x": 0.0,           // ENUä¸œå‘ä½ç½®
  "pos_y": 0.0,           // ENUåŒ—å‘ä½ç½®
  "pos_z": 25.5,          // ENUé«˜åº¦
  "vel_x": 2.5,           // ENUä¸œå‘é€Ÿåº¦
  "vel_y": 1.2,           // ENUåŒ—å‘é€Ÿåº¦
  "vel_z": 0.5,           // ENUå‚å‘é€Ÿåº¦
  "euler_phi": 5.2,       // Rollè§’
  "euler_theta": 2.1,     // Pitchè§’
  "euler_psi": 180.5,     // Yawè§’
  "control_mode": 1,      // æ§åˆ¶æ¨¡å¼
  "flight_mode": 0         // é£è¡Œæ¨¡å¼
}
```

### âš¡ é¿éšœæ ‡å¿— (avoiflag)

```json
{
  "laser_radar_enabled": true,   // æ¿€å…‰é›·è¾¾å¯ç”¨
  "avoidance_flag": false,        // é¿éšœæ¿€æ´»
  "guide_flag": false            // å¼•å¯¼æ¿€æ´»
}
```

---

### 2. å®æ—¶æ•°æ®æ¨é€ï¼ˆWebSocketï¼‰

UDPæ•°æ®åŒ…æ¥æ”¶åï¼Œåç«¯ä¼šç«‹å³é€šè¿‡WebSocketå¹¿æ’­åˆ°æ‰€æœ‰è¿æ¥çš„å‰ç«¯å®¢æˆ·ç«¯ã€‚

#### æ¶ˆæ¯æ ¼å¼

```json
{
  "type": "udp_data",
  "timestamp": 1737273625000,
  "data": {
    "type": "fcs_states",
    "func_code": 66,
    "data": {
      // è§£æåçš„æ•°æ®å­—æ®µ
    }
  }
}
```

#### è¿æ¥ç®¡ç†

- **ç«¯ç‚¹**: `ws://localhost:8000/ws/drone`
- **å¤šå®¢æˆ·ç«¯æ”¯æŒ**: æ”¯æŒå¤šä¸ªå‰ç«¯åŒæ—¶è¿æ¥
- **è‡ªåŠ¨é‡è¿**: æ–­å¼€è¿æ¥æ—¶è‡ªåŠ¨æ¸…ç†ï¼Œæ”¯æŒå®¢æˆ·ç«¯é‡è¿

---

### 3. æŒ‡ä»¤å‘é€èƒ½åŠ›

åç«¯æ”¯æŒé€šè¿‡REST APIå‘é€å¤šç§æŒ‡ä»¤åˆ°é£æ§ã€‚

#### åŸºç¡€é£è¡ŒæŒ‡ä»¤

| æŒ‡ä»¤ç±»å‹ | APIç«¯ç‚¹ | å‚æ•°ç¤ºä¾‹ | è¯´æ˜ |
|---------|---------|---------|------|
| **èµ·é£** | `POST /api/command` | `{"type": "takeoff"}` | è‡ªåŠ¨èµ·é£ |
| **é™è½** | `POST /api/command` | `{"type": "land"}` | è‡ªåŠ¨é™è½ |
| **æ‚¬åœ** | `POST /api/command` | `{"type": "hover"}` | æ‚¬åœ |
| **è¿”èˆª** | `POST /api/command` | `{"type": "rtl"}` | è¿”å›èµ·é£ç‚¹ |

#### æ§åˆ¶æŒ‡ä»¤

```bash
# CmdIdxæŒ‡ä»¤ï¼ˆ25ç§æŒ‡ä»¤ï¼‰
POST /api/command
{
  "type": "cmd_idx",
  "params": {
    "cmdId": 14  # 14=è‡ªåŠ¨èµ·é£
  }
}

# ä»»åŠ¡æŒ‡ä»¤
POST /api/command
{
  "type": "cmd_mission",
  "params": {
    "cmdId": 0,
    "value": 10.5
  }
}
```

#### é¿éšœæ§åˆ¶

```bash
POST /api/command
{
  "type": "avoidance_enable",
  "params": {
    "enable": true
  }
}
```

#### èˆªç‚¹æŒ‡ä»¤

```bash
# å•èˆªç‚¹
POST /api/command
{
  "type": "gcs_command",
  "params": {
    "seqId": 1,
    "targetX": 100.0,
    "targetY": 200.0,
    "targetZ": 50.0,
    "cruiseSpeed": 10.0,
    "enable": 1,
    "cmdId": 0
  }
}

# å¤šèˆªç‚¹ä¸Šä¼ 
POST /api/command
{
  "type": "waypoints_upload",
  "params": {
    "waypoints": [
      {"x": 100, "y": 200, "z": 50},
      {"x": 150, "y": 250, "z": 60}
    ],
    "cruiseSpeed": 10.0
  }
}
```

---

### 4. æ•°æ®è®°å½•èƒ½åŠ›

åç«¯æ”¯æŒå°†æ¥æ”¶åˆ°çš„UDPæ•°æ®è®°å½•åˆ°æ–‡ä»¶ï¼Œæ”¯æŒä¸¤ç§æ ¼å¼ã€‚

#### CSVæ ¼å¼

```csv
timestamp,category,lat,lon,alt,roll,pitch,yaw,vx,vy,vz,wx,wy,wz
2026-01-15 12:30:45.123,fcs_states,39.084200,117.201000,25.50,5.20,2.10,180.50,2.50,1.20,0.50,0.02,0.03,0.01
```

#### Binaryæ ¼å¼ï¼ˆJSONï¼‰

```json
{"timestamp": "2026-01-15 12:30:45.123", "category": "fcs_states", "message": {...}}
```

#### é…ç½®API

```bash
# è·å–æ—¥å¿—é…ç½®
GET /api/config/log

# æ›´æ–°æ—¥å¿—é…ç½®
POST /api/config/log
{
  "logDirectory": "./logs",
  "autoRecord": true,
  "logFormat": "csv",
  "logLevel": "1"
}
```

---

### 5. é…ç½®ç®¡ç†èƒ½åŠ›

#### UDPè¿æ¥é…ç½®

```json
{
  "protocol": "udp",
  "hostIp": "127.0.0.1",
  "hostPort": 30509,           // åœ°é¢ç«™ç›‘å¬ç«¯å£
  "remoteIp": "127.0.0.1",     // é£æ§IP
  "commandRecvPort": 18504,     // é£æ§æ¥æ”¶æŒ‡ä»¤ç«¯å£
  "sendOnlyPort": 18506,        // é£æ§å‘é€é¥æµ‹ç«¯å£
  "lidarSendPort": 18507,
  "planningSendPort": 18510,
  "planningRecvPort": 18511
}
```

#### è¿è¡Œæ¨¡å¼

- **æµ‹è¯•æ¨¡å¼** (`testing`): è‡ªåŠ¨å¯åŠ¨UDPæœåŠ¡å™¨ï¼Œç›‘å¬30509ç«¯å£
- **ç”Ÿäº§æ¨¡å¼** (`production`): ç­‰å¾…å‰ç«¯é…ç½®åå¯åŠ¨

---

## ğŸ—ï¸ ä»£ç ç»“æ„

### ç›®å½•ç»“æ„

```
src-python/
â”œâ”€â”€ main.py                           # ä¸»ç¨‹åºï¼ˆæ—§ç‰ˆï¼ŒåŒ…å«é‡å¤ä»£ç ï¼‰
â”œâ”€â”€ main_clean.py                     # ç²¾ç®€ç‰ˆä¸»ç¨‹åºï¼ˆæ¨èä½¿ç”¨ï¼‰
â”œâ”€â”€ config.py                         # é…ç½®ç®¡ç†
â”œâ”€â”€ protocol/
â”‚   â”œâ”€â”€ nclink_protocol.py           # åè®®å®šä¹‰å’Œæ•°æ®ç»“æ„
â”‚   â”œâ”€â”€ protocol_parser.py            # åè®®è§£æå™¨ï¼ˆæ—§ç‰ˆï¼‰
â”‚   â””â”€â”€ protocol_parser_clean.py     # ç²¾ç®€ç‰ˆè§£æå™¨ï¼ˆæ¨èä½¿ç”¨ï¼‰
â””â”€â”€ websocket/
    â””â”€â”€ websocket_manager.py          # WebSocketè¿æ¥ç®¡ç†å™¨
```

### æ¨¡å—èŒè´£

| æ¨¡å— | èŒè´£ |
|------|------|
| **main_clean.py** | FastAPIåº”ç”¨ã€è·¯ç”±ã€UDPæœåŠ¡å™¨ç®¡ç† |
| **config.py** | å…¨å±€é…ç½®å•ä¾‹ã€è¿è¡Œæ¨¡å¼ç®¡ç† |
| **nclink_protocol.py** | NCLinkåè®®å®šä¹‰ã€æ•°æ®ç»“æ„ã€ç¼–ç å‡½æ•° |
| **protocol_parser_clean.py** | UDPæ¥æ”¶ã€åè®®è§£æã€æ•°æ®å¤„ç† |
| **websocket_manager.py** | WebSocketè¿æ¥ã€æ¶ˆæ¯å¹¿æ’­ |

---

## ğŸ”„ æ•°æ®æµ

### UDPæ•°æ®æ¥æ”¶æµç¨‹

```
1. UDPæ•°æ®åŒ… â†’ [NCLinkUDPServerProtocol]
              â†“
2. æ•°æ®éªŒè¯ â†’ [UDPHandler.process_data]
              â†“
3. åè®®è§£æ â†’ [NCLinkProtocolParser]
              â†“
4. æ•°æ®è½¬æ¢ â†’ [æ•°æ®ç»“æ„.from_bytes]
              â†“
5. å›è°ƒå¤„ç† â†’ [on_udp_message_received]
              â†“
6. WebSocketå¹¿æ’­ â†’ [WebSocketManager.broadcast]
              â†“
7. æ•°æ®è®°å½• â†’ [save_data_to_log]
```

### æŒ‡ä»¤å‘é€æµç¨‹

```
1. å‰ç«¯è¯·æ±‚ â†’ [POST /api/command]
              â†“
2. æŒ‡ä»¤ç¼–ç  â†’ [encode_*_command]
              â†“
3. æ•°æ®åŒ…å°è£… â†’ [encode_command_packet]
              â†“
4. UDPå‘é€ â†’ [UDPHandler.send_data]
              â†“
5. é£æ§æ¥æ”¶ â†’ é£æ§å¤„ç†æŒ‡ä»¤
```

---

## ğŸ› ï¸ ä»£ç æ”¹è¿›ç‚¹

### å·²å®Œæˆçš„æ”¹è¿›

1. âœ… **ç§»é™¤é‡å¤ä»£ç **:
   - åˆ é™¤äº†`main.py`ä¸­çš„`ConnectionManager`
   - ç»Ÿä¸€ä½¿ç”¨`websocket_manager.py`çš„`WebSocketManager`

2. âœ… **æ¸…ç†æµ‹è¯•ä»£ç **:
   - ç§»é™¤äº†`protocol_parser.py`ä¸­çš„æµ‹è¯•å‡½æ•°
   - åˆ›å»ºäº†`protocol_parser_clean.py`ç²¾ç®€ç‰ˆ

3. âœ… **å®Œå–„æ•°æ®è®°å½•**:
   - æ”¯æŒæ‰€æœ‰æ•°æ®ç±»å‹çš„è®°å½•
   - ç»Ÿä¸€çš„CSVæ ¼å¼è¾“å‡º
   - æ”¯æŒBinaryæ ¼å¼ï¼ˆJSONï¼‰

4. âœ… **ä¼˜åŒ–é…ç½®ç®¡ç†**:
   - æ”¯æŒåŠ¨æ€é…ç½®æ›´æ–°
   - é…ç½®å˜æ›´æ—¶è‡ªåŠ¨é‡å¯UDPæœåŠ¡å™¨
   - é…ç½®å¹¿æ’­åˆ°æ‰€æœ‰å‰ç«¯

### æ¨èä½¿ç”¨çš„æ–‡ä»¶

| åŠŸèƒ½ | æ¨èæ–‡ä»¶ | è¯´æ˜ |
|------|---------|------|
| ä¸»ç¨‹åº | `main_clean.py` | ç²¾ç®€ç‰ˆï¼Œæ— é‡å¤ä»£ç  |
| åè®®è§£æ | `protocol_parser_clean.py` | ç²¾ç®€ç‰ˆï¼Œç§»é™¤æµ‹è¯•ä»£ç  |
| WebSocket | `websocket_manager.py` | ç»Ÿä¸€çš„è¿æ¥ç®¡ç†å™¨ |
| é…ç½® | `config.py` | å•ä¾‹æ¨¡å¼ï¼Œæ”¯æŒå¤šç¯å¢ƒ |

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### æ•°æ®å¤„ç†èƒ½åŠ›

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| UDPæ•°æ®åŒ…å¤„ç†é¢‘ç‡ | ~20Hzï¼ˆé£æ§å‘é€é¢‘ç‡ï¼‰ |
| WebSocketè¿æ¥æ•° | æ”¯æŒå¤šå®¢æˆ·ç«¯åŒæ—¶è¿æ¥ |
| æ•°æ®è®°å½•æ€§èƒ½ | CSVæ ¼å¼ ~2MB/åˆ†é’Ÿ |
| å»¶è¿Ÿ | UDPæ¥æ”¶ â†’ WebSocketæ¨é€ < 10ms |

### èµ„æºå ç”¨

| èµ„æº | å…¸å‹å€¼ |
|------|--------|
| å†…å­˜å ç”¨ | ~50MB |
| CPUå ç”¨ | < 5%ï¼ˆç©ºé—²æ—¶ï¼‰ |
| ç½‘ç»œå¸¦å®½ | ~500KB/sï¼ˆ20Hzæ•°æ®æµï¼‰ |

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

1. **æ€§èƒ½ä¼˜åŒ–**:
   - å®ç°æ•°æ®æ‰¹é‡è®°å½•ï¼ˆå‡å°‘IOæ“ä½œï¼‰
   - æ·»åŠ æ•°æ®å‹ç¼©ï¼ˆBinaryæ ¼å¼ï¼‰
   - å®ç°å†å²æ•°æ®æŸ¥è¯¢API

2. **åŠŸèƒ½æ‰©å±•**:
   - æ·»åŠ æ•°æ®å›æ”¾åŠŸèƒ½
   - å®ç°æ•°æ®ç»Ÿè®¡å’Œåˆ†æ
   - æ”¯æŒå®æ—¶å‘Šè­¦

3. **å¯é æ€§å¢å¼º**:
   - æ·»åŠ æ•°æ®æ ¡éªŒå’Œå¼‚å¸¸æ£€æµ‹
   - å®ç°æ–­çº¿é‡è¿æœºåˆ¶
   - æ·»åŠ æ•°æ®å¤‡ä»½

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.0 (2026-01-15)

- âœ… å®Œæ•´çš„NCLinkV2.0åè®®æ”¯æŒ
- âœ… UDPå¤šç«¯å£ç›‘å¬
- âœ… WebSocketå®æ—¶æ•°æ®æ¨é€
- âœ… æŒ‡ä»¤å‘é€åŠŸèƒ½
- âœ… æ•°æ®è®°å½•åŠŸèƒ½ï¼ˆCSV + Binaryï¼‰
- âœ… é…ç½®ç®¡ç†API
- âœ… ä»£ç æ¸…ç†å’Œä¼˜åŒ–

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [é…ç½®è¯´æ˜.md](./é…ç½®è¯´æ˜.md)
- [æµ‹è¯•æŒ‡å—.md](./æµ‹è¯•æŒ‡å—.md)
- [IPé…ç½®è¯´æ˜.md](./IPé…ç½®è¯´æ˜.md)