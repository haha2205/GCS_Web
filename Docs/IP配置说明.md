# Apollo-GCS Web IP配置说明

## 📋 完整的IP/端口配置逻辑

### 🚁 飞控模拟器端（FcSim）

**运行环境：**
- 操作系统：Windows
- 绑定源端口：18506（自动，飞控发送遥测的源端口）

**发送遥测数据到：**
- 目标地址：**127.0.0.1:30509**（硬编码在飞控模拟器中）

**接收指令的监听端口：**
- 监听端口：**18504**（fc_basic_recv.exe监听此端口）

---

### 🖥️ 地面站后端端（GCS Backend）

**运行环境：**
- 操作系统：Windows
- FastAPI监听：**0.0.0.0:8000**（接受所有连接）
- WebSocket端点：**ws://localhost:8000/ws/drone**

**UDP服务器配置：**
- 监听地址：**0.0.0.0:30509**（绑定到所有网络接口）
  - 用于接收：来自飞控模拟器的遥测数据（0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x49）
  - 用于接收：来自LiDAR模拟器的障碍物数据（18507端口）
  - 用于接收：来自飞控的规划响应数据（18511端口）

- 监听端口：**18507**（LiDAR数据）
- 监听端口：**18511**（规划响应数据）

**UDP发送目标地址配置：**
- 发送目标地址：**127.0.0.1:18504**
  - 这是飞控的接收指令端口（fc_basic_recv.exe监听此端口）
  - 用于发送：起飞、降落、悬停、避障等指令

**重要说明：**
- ❌ **不**发送目标到30509（30509是监听端口，不是飞控接收端口）
- ❌ **不**发送到127.0.0.2（飞控模拟器实际运行在127.0.0.1）

---

### 🌐 前端配置界面（GCS Frontend）

**连接配置应该填写：**

```
┌─────────────────────────────────────────────┐
│ 【本地端（GCS）配置】                  │
│ ┌─────────────────────────────────────┐   │
│ │ Protocol: UDP                    │   │
│ │ Host IP: 127.0.0.1               │   │
│ │ Host Port: 30509                  │   │
│ └─────────────────────────────────────┘   │
│                                         │
│ 【远程端（飞控）配置】                  │
│ ┌─────────────────────────────────────┐   │
│ │ Remote IP: 127.0.0.1              │   │
│ │ 指令上行: 18504                  │   │
│ │ 遥测下行: 18506 (仅供参考)        │   │
│ │ LiDAR下行: 18507                 │   │
│ │ 规划上行: 18510                  │   │
│ │ 规划下行: 18511                  │   │
│ └─────────────────────────────────────┘   │
└─────────────────────────────────────────────┘
```

**配置解释：**

**本地端（GCS）：**
- **Host IP (127.0.0.1)**: 地面站运行在本机上的IP地址（应该与飞控模拟器IP相同）
- **Host Port (30509)**: 地面站监听遥测数据的端口（飞控模拟器发送到此端口）

**远程端（飞控）：**
- **Remote IP (127.0.0.1)**: 飞控模拟器运行的IP地址
- **指令上行 (18504)**: 飞控接收地面站指令的端口（fc_basic_recv.exe监听此端口）
- **遥测下行 (18506)**: 飞控发送遥测数据的源端口（仅供参考，地面站不需要监听此端口）

---

## 🔄 完整数据流

### ✅ 正常数据流：

```
飞控模拟器 (127.0.0.1:18506)
    │
    │ [发送遥测数据]
    ▼
地面站后端 (0.0.0.0:30509)
    │
    │ [接收UDP数据] → [解析NCLink协议] → [WebSocket广播]
    ▼
前端浏览器 (ws://localhost:8000/ws/drone)
    │
    │ [接收WebSocket消息] → [更新UI显示]
    ▼
用户界面 (实时显示)
```

### 🔧 后端发送指令流：

```
前端浏览器用户
    │
    │ [点击起飞按钮] → [REST API: POST /api/command]
    ▼
地面站后端
    │
    │ [编码NCLink数据包] → [UDP发送到 127.0.0.1:18504]
    ▼
飞控接收程序 (127.0.0.1:18504) ← fc_basic_recv.exe
    │
    │ [接收指令] → [处理并响应]
    ▼
飞控模拟器
```

---

## ⚠️ 常见配置错误

### ❌ 错误1: remoteIp设置为127.0.0.2
**现象**：后端发送指令到127.0.0.2:30509，但飞控实际在127.0.0.1
**原因**：IP地址不匹配
**修复**：将remoteIp改为127.0.0.1

### ❌ 错误2: 发送指令时使用30509作为目标端口
**现象**：后端发送指令到30509端口，但飞控的接收端口是18504
**原因**：理解了错误的端口用途
**修复**：发送指令到18504端口（commandRecvPort）

### ❌ 错误3: Host IP和Remote IP设置不一致
**现象**：Host IP设置为127.0.0.2，但飞控实际在127.0.0.1
**原因**：IP地址配置混乱
**修复**：Host IP和Remote IP都设置为127.0.0.1（本机）

---

## 🔍 故障排查步骤

### 步骤1: 确认进程运行
```
# Windows任务管理器中应该看到：
✓ fc_basic_send.exe      （飞控遥测发送）
✓ fc_basic_recv.exe      （飞控指令接收，可选）
✓ python.exe (main.py)  （地面站后端）
```

### 步骤2: 检查后端日志
打开后端控制台或查看`gcs_backend.log`，应该看到：
```
INFO: 多端口UDP服务器已启动:
INFO:   - 地面站总监听端口: 30509 (接收来自飞控)
INFO:   - LiDAR数据端口: 18507 (接收障碍物数据)
INFO:   - 规划响应端口: 18511 (接收规划响应)
INFO: 发送目标地址: 127.0.0.1:30509 (发送指令到飞控) ← 注意这里！
```

**关键检查点：**
- ✓ UDP服务器已启动
- ✓ 监听在30509端口
- ✓ 发送目标到127.0.0.1（不是127.0.0.2！）

### 步骤3: 检查UDP数据接收
后端日志应该显示：
```
INFO: [端口30509] 收到来自 ('127.0.0.1', 18506) 的数据，长度: XX
INFO:   数据预览: ff fc 41 00 40 00 91 e2 46 9d ...
```

如果看到这条日志，说明UDP接收正常！

### 步骤4: 检查前端WebSocket
打开浏览器开发者工具 → Console，应该看到：
```javascript
[WebSocket连接已建立]
[收到消息 #1: 类型=connection]
[收到消息 #2: 类型=config_update]
[收到消息 #3: 类型=udp_data] ← 重点是这个！
```

如果看到`类型=udp_data`，说明数据流正常！

---

## 📝 快速配置检查清单

使用此清单验证配置是否正确：

- [ ] **后端正在运行**？ (python main.py)
- [ ] **飞控模拟器正在运行**？ (fc_basic_send.exe)
- [ ] **Host IP = 127.0.0.1**
- [ ] **Host Port = 30509**
- [ ] **Remote IP = 127.0.0.1**
- [ ] **指令上行 = 18504**
- [ ] **遥测下行 = 18506**
- [ ] 后端日志显示"UDP服务器已启动"
- [ ] 后端日志显示发送目标为127.0.0.1:18504
- [ ] 后端日志显示"收到来自127.0.0.1的数据"
- [ ] 前端显示"类型=udp_data"消息

---

## 🎯 总结

1. **本机测试环境下，所有IP地址都应该设置为 127.0.0.1**
2. **地面站监听30509端口接收遥测数据**
3. **地面站发送指令到18504端口（飞控接收端口）**
4. **不要混淆监听端口和目标端口**
5. **飞控的18506端口是发送遥测的源端口，地面站不需要监听此端口**

配置正确的标志是：
- 飞控模拟器发送数据 → 后端收到并广播 → 前端显示
- 前端点击按钮 → 后端发送指令 → 飞控接收并处理